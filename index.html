<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatOgre Editor ðŸš§ Under Construction</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
</head>

<body>
    <div id="app">
        <div class="navbar-wrap">
            <div class="navbar-content">
                <div class="navbar-left">
                    <img src="./media/logo.svg" alt="Logo" draggable="false" class="navbar-logo">
                    <div class="line"></div>

                    <div class="navbar-dropdown" tabindex="0">
                        <div class="dropdown-head">File</div>
                        <div class="dropdown-items">
                            <button class="dropdown-item">New Project</button>
                            <hr>
                            <button class="dropdown-item">Save</button>
                            <button class="dropdown-item">Load</button>
                            <hr>
                            <button class="dropdown-item">Save As New</button>
                            <button class="dropdown-item">Rewind To Last Save</button>
                        </div>
                    </div>

                    <div class="navbar-dropdown" tabindex="0">
                        <div class="dropdown-head">Edit</div>
                        <div class="dropdown-items">
                            <button class="dropdown-item">Undo</button>
                            <button class="dropdown-item">Redo</button>
                            <hr>
                            <button class="dropdown-item">Enable Turbo Mode</button>
                            <button class="dropdown-item">Enable Full Screen</button>
                            <hr>
                            <button class="dropdown-item">Preferences</button>
                            <button class="dropdown-item">Help</button>
                        </div>
                    </div>

                    <div class="navbar-dropdown" tabindex="0">
                        <div class="dropdown-head">Info</div>
                        <div class="dropdown-items">
                            <button class="dropdown-item">Report Bug</button>
                            <button class="dropdown-item">Contribute on Github</button>
                            <hr>
                            <button class="dropdown-item">About CatOgre</button>
                            <button class="dropdown-item">Terms of Service</button>
                            <hr>
                            <button class="dropdown-item">Connect to Scratch</button>
                        </div>
                    </div>

                    <div class="line"></div>

                    <input type="text" class="navbar-name" id="projName" placeholder="Name Your Project" value="Untitled">
                </div>
                <div class="navbar-right">

                </div>
            </div>
        </div>

        <div class="main-space">
            <div class="workspace">
                <div class="code-lines" id="linesCount"></div>
                <div class="code-edit">
                    <div id="code"></div>
                    <textarea id="input" spellcheck="false"></textarea>
                </div>
            </div>
            <div class="stage">
                <div class="stage-player">
                    <canvas width="400" height="300" id="stageCanvas"></canvas>
                </div>
                <div class="stage-sprites"></div>
            </div>
        </div>
    </div>
</body>

<script src="./scripts/commandsList.js"></script>
<script src="./scripts/smoothDrag.js"></script>
<script>
    
    //Highlight Syntax

    const codeArea = document.querySelector("#code");
    const inputArea = document.querySelector("#input");

    let currentLine = 0;

    const highlight = (str) => {
        let lines = str.split("\n")
        let classes = /(sprite|input)/g
        let numbers = /(-)?\d+/g
        let symbols = /(\(|\)|;|{|})/g
        let strings = /"(.*)"/g
        codeArea.innerHTML = "";

        
        lines.forEach(line => {
            line = line.replace(strings, "<span class=\"string\">$&</span>")
            line = line.replace(symbols, "<span class=\"symbol\">$&</span>")
            line = line.replace(numbers, "<span class=\"number\">$&</span>")
            line = line.replace(classes, "<span class=\"class\">$&</span>")

            commandsList.forEach(com => {
                let filter = line.includes(com.command);
                if(filter){
                    let r = new RegExp(com.command, 'g');
                    line = line.replace(r, `<span class=\"${com.category}\">$&</span>`);
                }
            });

            codeArea.innerHTML += `<div class="line">${line}</div>`
        })
    }

    window.addEventListener("load", () => {
        inputArea.addEventListener("input", (e) => {
            highlight(inputArea.value);
            updateCurrentLine();

            //autocomplete brackets
            if(e.data == '('){
                let selStart = inputArea.selectionStart;
                let selEnd = inputArea.selectionEnd;
                inputArea.value = `${inputArea.value.slice(0, selStart)})${inputArea.value.slice(selEnd)}`;
                inputArea.setSelectionRange(selStart, selEnd);
                highlight(inputArea.value);
            }else if(e.data == '{'){
                let selStart = inputArea.selectionStart;
                let selEnd = inputArea.selectionEnd;
                inputArea.value = `${inputArea.value.slice(0, selStart)}}${inputArea.value.slice(selEnd)}`;
                inputArea.setSelectionRange(selStart, selEnd);
                highlight(inputArea.value);
            }
            else if(e.data == '"'){
                let selStart = inputArea.selectionStart;
                let selEnd = inputArea.selectionEnd;
                inputArea.value = `${inputArea.value.slice(0, selStart)}"${inputArea.value.slice(selEnd)}`;
                inputArea.setSelectionRange(selStart, selEnd);
                highlight(inputArea.value);
            }
        });

        //prevents browser's response to tab key when you're editing the input
        window.onkeydown = (e) => {
            if(document.activeElement == inputArea && e.keyCode == 9) return false;
        }

        //these event listeners together should trigger when caret's position changes, 
        //since there's no built-in listener for that
        inputArea.addEventListener("mousedown", () => {
            setTimeout(() => updateCurrentLine(), 10);
            inputArea.onmousemove = () => updateCurrentLine();
        });
        inputArea.addEventListener("mouseup", () => {
            inputArea.onmousemove = null;
            updateCurrentLine();
        });
        inputArea.addEventListener("keydown", (e) => {
            setTimeout(() => updateCurrentLine(), 10);
            
            if(e.keyCode == 9){
                let selStart = inputArea.selectionStart;
                let selEnd = inputArea.selectionEnd;
                inputArea.value = `${inputArea.value.slice(0, selStart)}    ${inputArea.value.slice(selEnd)}`;
                inputArea.setSelectionRange(selStart + 4, selEnd  + 4);
                highlight(inputArea.value);
            }
        });

        //properly react to scrolling
        inputArea.addEventListener("scroll", () => {
            codeArea.scrollTop = inputArea.scrollTop;
            codeArea.scrollLeft = inputArea.scrollLeft;
            document.getElementById('linesCount').style.marginTop = `-${inputArea.scrollTop}px`;
        });
    });

    //Lines Counter
    function renderLines(){
        let linesCount = document.getElementById('linesCount');
        linesCount.innerHTML = null;
        let lineslen = codeArea.children.length;
        for(let i = 0; i < lineslen; i++){
            linesCount.innerHTML += `<p>${i+1}</p>`;
        }
    }

    //get the number of the line the user is currently on
    function getCurrentLine(){
        let inputSplited = inputArea.value.split('\n');
        let char = 1;
        for(let i = 0; i < inputSplited.length; i++){
            for(let h = 0; h < inputSplited[i].length; h++){
                if(inputArea.selectionStart == inputArea.selectionEnd && inputArea.selectionStart == char){
                    return i;
                }
                char++;
            }
            char++;
        }
        if(inputArea.selectionStart != inputArea.selectionEnd){
            char = null;
            return char;
        }
    }

    //highlight the line the user is currently on
    function updateCurrentLine(){
        for(let i = 0; i < codeArea.children.length; i++){
            codeArea.children[i].classList.remove('sel');
        }
        currentLine = getCurrentLine();
        if(currentLine!= null) codeArea.children[currentLine].classList.add('sel');
    }

    codeArea.addEventListener("DOMSubtreeModified", () => renderLines());
</script>
</html>
